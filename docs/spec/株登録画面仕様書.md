# 株登録画面仕様書

## 1. 画面概要

新規株銘柄をシステムに登録するためのフォーム画面。銘柄コード（4桁）と銘柄名を入力し、バリデーションを経て登録処理を実行する。

### 1.1 画面URL
- パス: `/stocks/new`

### 1.2 画面イメージ

（画面モックアップは実装時に追加予定）

---

## 2. 画面項目定義

### 2.1 ヘッダーエリア

| 項目名 | 種別 | 説明 |
|--------|------|------|
| 画面タイトル | テキスト | 「株銘柄の新規登録」を表示 |

### 2.2 フォームエリア

#### 2.2.1 銘柄コード入力欄

| 項目名 | 種別 | 説明 |
|--------|------|------|
| ラベル | テキスト | 「銘柄コード」（必須マーク付き） |
| 入力フィールド | テキスト入力 | 英数字4桁の銘柄コードを入力 |
| プレースホルダー | テキスト | 「7203 または AAPL」 |
| 最大文字数 | 制限 | 4文字 |
| ヘルプテキスト | テキスト | 「英数字4桁の証券コードを入力してください」 |
| エラーメッセージ表示領域 | エラーテキスト | バリデーションエラー時に表示 |

#### 2.2.2 銘柄名入力欄

| 項目名 | 種別 | 説明 |
|--------|------|------|
| ラベル | テキスト | 「銘柄名」（必須マーク付き） |
| 入力フィールド | テキスト入力 | 銘柄名を入力（日本語・英語対応） |
| プレースホルダー | テキスト | 「トヨタ自動車」 |
| 最大文字数 | 制限 | 100文字 |
| ヘルプテキスト | テキスト | 「銘柄名を入力してください（100文字以内）」 |
| エラーメッセージ表示領域 | エラーテキスト | バリデーションエラー時に表示 |

### 2.3 アクションボタンエリア

| 項目名 | 種別 | 説明 |
|--------|------|------|
| キャンセルボタン | ボタン | フォームをクリアして株一覧画面に戻る |
| 登録ボタン | ボタン（primary） | バリデーション後、登録APIを呼び出す |

### 2.4 状態表示

| 項目名 | 種別 | 説明 |
|--------|------|------|
| ローディング表示 | ボタンテキスト変更 | 登録ボタンが「登録中...」に変化、ボタン無効化 |
| 成功メッセージ | トースト通知 | 「株を登録しました」を表示後、株一覧画面へ遷移 |
| エラーメッセージ | エラー表示 | フォーム上部にエラーメッセージを表示 |

---

## 3. 操作処理詳細

### 3.1 初期表示処理

#### 処理概要
画面表示時にフォームを初期化し、空の入力欄を表示する。

#### 処理フロー
1. 画面マウント時にフォームステートを初期化
2. 銘柄コード入力欄を空文字列に設定
3. 銘柄名入力欄を空文字列に設定
4. エラーメッセージをクリア
5. フォームを表示

### 3.2 入力バリデーション

#### 処理概要
ユーザーが入力した値をリアルタイムおよび送信時にバリデーションし、エラーがあれば即座にフィードバックを提供する。

#### 処理フロー
1. ユーザーがフォームフィールドに入力
2. 「登録」ボタンクリック時にバリデーション実行
3. バリデーションルールをチェック
4. エラーがある場合、該当フィールド下にエラーメッセージを表示
5. エラーがない場合、登録処理（3.3）へ進む

#### バリデーションルール

**銘柄コード:**
- 必須チェック: 空の場合 → 「銘柄コードは必須です」
- 形式チェック: 英数字4桁でない場合 → 「銘柄コードは英数字4桁である必要があります」
- 正規表現: `/^[A-Za-z0-9]{4}$/`

**銘柄名:**
- 必須チェック: 空の場合 → 「銘柄名は必須です」
- 長さチェック: 100文字超過の場合 → 「銘柄名は100文字以内で入力してください」

### 3.3 登録処理

#### 処理概要
バリデーションをパスした入力データをバックエンドAPIに送信し、新規株銘柄を登録する。

#### 処理フロー
1. フロントエンドバリデーション成功
2. 入力値を加工（前後の空白削除、銘柄コードを大文字に変換）
3. ローディング状態を開始（ボタンテキストを「登録中...」に変更、ボタン無効化）
4. `POST /api/v1/stocks` APIを呼び出し
5. レスポンス受信
   - 成功（201 Created）: 成功メッセージを表示し、株一覧画面へ遷移
   - 失敗: エラーハンドリング（3.4参照）
6. ローディング状態を解除

#### データ送信API
- **エンドポイント**: `POST /api/v1/stocks`
- **リクエストボディ**:
```typescript
{
  stockCode: string,  // 英数字4桁（大文字変換済み、前後空白削除済み）
  stockName: string   // 1〜100文字（前後空白削除済み）
}
```
- **成功レスポンス（201 Created）**:
```typescript
{
  success: true,
  data: {
    stock: {
      stockId: number,
      stockCode: string,
      stockName: string,
      createdAt: string,
      updatedAt: string
    }
  },
  message: "株を登録しました"
}
```

### 3.4 キャンセル処理

#### 処理概要
ユーザーが「キャンセル」ボタンをクリックすると、入力内容を破棄して株一覧画面へ戻る。

#### 処理フロー
1. ユーザーが「キャンセル」ボタンをクリック
2. フォーム入力内容をクリア（確認ダイアログは表示しない）
3. React Routerを使用して `/stocks` へ画面遷移
4. 株一覧画面が表示される

### 3.5 登録成功後の遷移処理

#### 処理概要
登録APIが成功した後、成功メッセージを表示し、株一覧画面へ自動遷移する。

#### 処理フロー
1. API成功レスポンスを受信
2. 成功メッセージ「株を登録しました」を画面に表示（トースト通知など）
3. React Routerを使用して `/stocks` へ画面遷移
4. 株一覧画面が表示され、登録した銘柄が一覧に含まれる

---

## 4. エラーハンドリング

### 4.1 エラー種別

| エラー種別 | HTTPステータス | 表示メッセージ | 対応 |
|-----------|--------------|---------------|------|
| バリデーションエラー（フロントエンド） | - | フィールドごとのエラーメッセージ | 該当フィールド下に赤文字でエラー表示、送信をブロック |
| バリデーションエラー（バックエンド） | 400 Bad Request | 「入力内容に誤りがあります」 | フォーム上部にエラー表示、詳細エラーを各フィールドに表示 |
| 銘柄コード重複エラー | 409 Conflict | 「この銘柄コードは既に登録されています」 | フォーム上部にエラー表示、銘柄コードフィールドにフォーカス |
| サーバーエラー | 500 Internal Server Error | 「サーバーエラーが発生しました」 | フォーム上部にエラー表示、リトライを促す |
| ネットワークエラー | - | 「通信エラーが発生しました」 | フォーム上部にエラー表示、ネットワーク確認を促す |

### 4.2 エラー処理フロー

1. API呼び出し中に例外が発生
2. HTTPステータスコードを確認
3. エラーレスポンスの`error.code`を判定
4. エラー種別に応じた処理を実行:
   - **VALIDATION_ERROR (400)**: `details`オブジェクトから各フィールドのエラーメッセージを取得し、該当フィールドに表示
   - **STOCK_CODE_DUPLICATE (409)**: 「この銘柄コードは既に登録されています」をフォーム上部に表示、銘柄コードフィールドにフォーカス
   - **INTERNAL_SERVER_ERROR (500)**: 「サーバーエラーが発生しました」をフォーム上部に表示
   - **ネットワークエラー**: 「通信エラーが発生しました」をフォーム上部に表示
5. ローディング状態を解除
6. コンソールに詳細なエラーログを出力（開発者向け）

### 4.3 バックエンドバリデーションエラーの詳細表示

#### エラーレスポンス例
```typescript
{
  success: false,
  error: {
    code: "VALIDATION_ERROR",
    message: "入力内容に誤りがあります",
    details: {
      stockCode: "銘柄コードは英数字4桁である必要があります",
      stockName: "銘柄名は1文字以上入力してください"
    }
  }
}
```

#### 処理フロー
1. `error.details`オブジェクトを確認
2. 各キー（フィールド名）に対応するエラーメッセージを取得
3. フロントエンドのエラーステートに設定
4. 各フィールド下に赤文字でエラーメッセージを表示

### 4.4 重複エラーの特別処理

#### エラーレスポンス例
```typescript
{
  success: false,
  error: {
    code: "STOCK_CODE_DUPLICATE",
    message: "この銘柄コードは既に登録されています",
    details: {
      stockCode: "7203"
    }
  }
}
```

#### 処理フロー
1. エラーコードが`STOCK_CODE_DUPLICATE`であることを確認
2. フォーム上部にエラーメッセージ「この銘柄コードは既に登録されています」を表示
3. 銘柄コード入力フィールドにフォーカスを移動
4. ユーザーが別の銘柄コードを入力できるようにする
