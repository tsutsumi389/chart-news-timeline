# ニュースインポート画面仕様書

## 1. 画面概要

CSVファイルからニュースデータを一括インポートする画面。銘柄コードを指定してCSVファイルをアップロードし、バリデーション後にデータベースへ登録する。日付範囲フィルターと重複データの処理方法（スキップ/上書き）を選択可能。

### 1.1 画面URL
- パス: `/news-import`

### 1.2 画面イメージ

（画面モックアップは実装時に追加予定）

---

## 2. 画面項目定義

### 2.1 ヘッダーエリア

| 項目名 | 種別 | 説明 |
|--------|------|------|
| 画面タイトル | テキスト | 「ニュースデータインポート」を表示 |
| 説明テキスト | テキスト | 「CSVファイルからニュースデータを一括登録します」 |

### 2.2 インポート設定エリア

#### 2.2.1 銘柄選択

| 項目名 | 種別 | 説明 |
|--------|------|------|
| 銘柄コード入力欄 | テキスト入力 | 4桁の数字の銘柄コードを入力（例: 7203） |
| 銘柄情報表示 | テキスト | 入力された銘柄コードに対応する銘柄名を表示<br>例: 「7203 - トヨタ自動車」 |
| バリデーションエラー表示 | エラーテキスト | 銘柄コードが不正または見つからない場合にエラーメッセージを表示 |

#### 2.2.2 ファイル選択

| 項目名 | 種別 | 説明 |
|--------|------|------|
| ファイル選択ボタン | ファイル入力 | CSVファイルを選択するボタン<br>受け入れ形式: `.csv`<br>最大サイズ: 5MB |
| 選択ファイル名表示 | テキスト | 選択されたファイル名を表示 |
| ファイル形式説明 | ヘルプテキスト | 「CSV形式: publishedAt,title,summary,url,source,sentiment,sentimentScore」 |
| CSVフォーマット例 | コード | 正しいCSVフォーマットの例を表示 |

#### 2.2.3 日付範囲フィルター（オプション）

| 項目名 | 種別 | 説明 |
|--------|------|------|
| 開始日入力欄 | 日付入力 | インポート対象の開始日（YYYY-MM-DD形式）<br>例: 2024-01-01 |
| 終了日入力欄 | 日付入力 | インポート対象の終了日（YYYY-MM-DD形式）<br>例: 2024-12-31 |
| フィルター説明 | ヘルプテキスト | 「指定した期間のニュースのみをインポートします（省略可）」 |

#### 2.2.4 重複データ処理設定

| 項目名 | 種別 | 説明 |
|--------|------|------|
| 処理方法選択 | ラジオボタン | 重複データの処理方法を選択<br>・スキップ（skip）: 既存データを保持、新規データのみ登録<br>・上書き（overwrite）: 既存データを更新 |
| デフォルト値 | - | 「スキップ」を初期選択 |
| 説明テキスト | ヘルプテキスト | 「重複判定: 同一銘柄・公開日時・タイトルの組み合わせ」 |

### 2.3 アクションボタンエリア

| 項目名 | 種別 | 説明 |
|--------|------|------|
| インポート実行ボタン | ボタン（primary） | CSVファイルのアップロードとインポート処理を実行<br>銘柄コードとファイルが未入力の場合は無効化 |
| 重複チェックボタン | ボタン（secondary） | インポート前に重複ニュースを検出（オプション） |
| キャンセルボタン | ボタン | 入力内容をクリアし、初期状態に戻す |

### 2.4 進捗表示エリア

| 項目名 | 種別 | 説明 |
|--------|------|------|
| 進捗バー | プログレスバー | インポート処理の進捗を0〜100%で表示<br>段階: パース(20%)→フィルター(40%)→バリデーション(60%)→アップロード(80%)→完了(100%) |
| ステータスメッセージ | テキスト | 現在の処理ステータスを表示<br>例: 「CSVファイルをパースしています...」 |
| 処理中スピナー | スピナー | 処理実行中はスピナーアイコンを表示 |

### 2.5 結果表示エリア

#### 2.5.1 インポート成功時

| 項目名 | 種別 | 説明 |
|--------|------|------|
| 成功メッセージ | 成功通知 | 「ニュースのインポートが完了しました」を緑色で表示 |
| インポートID | テキスト | 一意のインポートID（例: `news_import_20240115123456_a1b2c3d4`） |
| 銘柄情報 | テキスト | 銘柄コードと銘柄名 |
| 総行数 | 数値 | CSVファイルの総データ行数（日付フィルター適用前） |
| フィルター後件数 | 数値 | 日付範囲フィルター適用後の件数 |
| 成功件数 | 数値（緑） | データベースに登録成功した件数 |
| スキップ件数 | 数値（黄） | 重複によりスキップされた件数（skip戦略時のみ） |
| エラー件数 | 数値（赤） | バリデーションエラーまたは登録エラーの件数 |
| インポート日時 | 日時 | インポート実行日時（ISO 8601形式） |

#### 2.5.2 エラー詳細

| 項目名 | 種別 | 説明 |
|--------|------|------|
| エラー一覧テーブル | テーブル | エラーが発生した行の詳細情報を表示<br>列: 行番号、公開日時、タイトル、エラーメッセージ |
| エラー件数表示 | テキスト | 「エラー: X件」と表示 |
| エラーの折りたたみ | アコーディオン | エラー件数が多い場合、初期状態では折りたたみ表示 |

#### 2.5.3 重複チェック結果

| 項目名 | 種別 | 説明 |
|--------|------|------|
| 重複チェック結果タイトル | テキスト | 「重複ニュース検出結果」 |
| 総ニュース数 | 数値 | チェック対象のニュース総数 |
| 重複件数 | 数値（黄） | 既存データと重複するニュースの件数 |
| 重複ニュース一覧 | テーブル | 重複ニュースの詳細<br>列: 公開日時、タイトル、既存ニュースID |

### 2.6 状態表示

| 項目名 | 種別 | 説明 |
|--------|------|------|
| ローディング表示 | スピナー/プログレスバー | 処理実行中は進捗バーとステータスメッセージを表示 |
| エラー表示 | エラーメッセージ | API通信エラーやファイル形式エラーを赤色で表示 |
| 警告表示 | 警告メッセージ | 一部データにエラーがある場合、黄色で警告を表示 |

---

## 3. 操作処理詳細

### 3.1 初期表示処理

#### 処理概要
画面表示時にフォームを初期化し、インポート設定入力欄を表示する。

#### 処理フロー
1. 画面マウント時にフォームステートを初期化
2. 銘柄コード入力欄を空に設定
3. ファイル選択を未選択に設定
4. 日付範囲フィルターを空に設定
5. 重複データ処理を「スキップ」に設定（デフォルト）
6. 進捗表示とエラー表示をクリア
7. フォームを表示

### 3.2 銘柄コード入力処理

#### 処理概要
ユーザーが銘柄コードを入力すると、リアルタイムでバリデーションを実行し、対応する銘柄情報を取得して表示する。

#### 処理フロー
1. ユーザーが銘柄コード入力欄に4桁の数字を入力
2. 入力値のバリデーション:
   - 4桁の数字形式チェック（正規表現: `/^\d{4}$/`）
   - 形式が不正な場合、エラーメッセージ「銘柄コードは4桁の数字である必要があります」を表示
3. 形式が正しい場合、`GET /api/v1/stocks/:stockCode` APIを呼び出し
4. 銘柄が存在する場合:
   - 銘柄名を取得し、「7203 - トヨタ自動車」形式で表示
   - インポート実行ボタンを有効化（ファイルも選択済みの場合）
5. 銘柄が見つからない場合:
   - エラーメッセージ「銘柄コード XXXX が見つかりません」を表示
   - インポート実行ボタンを無効化

### 3.3 ファイル選択処理

#### 処理概要
ユーザーがCSVファイルを選択すると、ファイル名を表示し、簡易的なバリデーションを実行する。

#### 処理フロー
1. ユーザーがファイル選択ボタンをクリック
2. ファイル選択ダイアログを表示（`.csv`ファイルのみフィルタ）
3. ファイルが選択された場合:
   - ファイル名を画面に表示
   - ファイルサイズをチェック（5MB以下）
   - ファイル拡張子をチェック（`.csv`）
   - バリデーション失敗時はエラーメッセージを表示
4. ファイル選択成功時、インポート実行ボタンを有効化（銘柄コードも入力済みの場合）

#### バリデーション
- **ファイルサイズ**: 5MB以下
- **ファイル形式**: `.csv`拡張子
- **MIMEタイプ**: `text/csv`, `text/plain`

### 3.4 インポート実行処理

#### 処理概要
ユーザーがインポート実行ボタンをクリックすると、CSVファイルをパース・バリデーション後、サーバーにアップロードしてデータベースへ登録する。

#### 処理フロー

**ステップ1: CSVファイルパース（進捗: 0% → 20%）**
1. インポート実行ボタンをクリック
2. 進捗バーを表示（0%）
3. ステータスメッセージ「CSVファイルを読み込んでいます...」を表示
4. CSVファイルを読み込み、パース処理を実行
5. ヘッダー行のチェック（`publishedAt,title,summary,url,source,sentiment,sentimentScore`）
6. データ行を配列に変換
7. 進捗を20%に更新

**ステップ2: 日付範囲フィルター（進捗: 20% → 40%）**
1. ステータスメッセージ「日付範囲フィルターを適用しています...」を表示
2. 開始日・終了日が指定されている場合、該当期間のニュースのみを抽出
3. フィルター適用後の件数を記録
4. 進捗を40%に更新

**ステップ3: フロントエンドバリデーション（進捗: 40% → 60%）**
1. ステータスメッセージ「X件のデータをバリデーションしています...」を表示
2. 各行のバリデーション:
   - 公開日時形式チェック（YYYY-MM-DD HH:MM:SS または ISO 8601）
   - タイトルチェック（必須、255文字以内）
   - URL形式チェック（http/https、500文字以内）
   - ソース長チェック（100文字以内）
   - センチメント値チェック（positive/negative/neutral）
   - センチメントスコア範囲チェック（-1.00〜1.00）
3. バリデーション結果を集計
4. 全行が無効な場合、エラーメッセージを表示して処理を中断
5. 一部の行のみ有効な場合、警告を表示して処理を継続
6. 進捗を60%に更新

**ステップ4: サーバーへアップロード（進捗: 60% → 80%）**
1. ステータスメッセージ「サーバーにアップロードしています...」を表示
2. `POST /api/v1/stocks/:stockCode/news/import/csv` APIを呼び出し
3. multipart/form-dataでCSVファイルとインポートオプションを送信
4. サーバー側でバリデーションとデータベース登録を実行
5. 進捗を80%に更新

**ステップ5: 完了処理（進捗: 80% → 100%）**
1. APIレスポンスを受信
2. インポート結果を結果表示エリアに表示
3. 進捗を100%に更新
4. ステータスメッセージ「ニュースのインポートが完了しました」を表示
5. 成功メッセージを緑色で表示

#### データ送信API
- **エンドポイント**: `POST /api/v1/stocks/:stockCode/news/import/csv`
- **リクエスト形式**: `multipart/form-data`
- **リクエストボディ**:
  - `file`: CSVファイル（バイナリ）
  - `duplicateStrategy`: 'skip' | 'overwrite'（オプション、デフォルト: 'skip'）
  - `dateFrom`: 開始日（YYYY-MM-DD形式、オプション）
  - `dateTo`: 終了日（YYYY-MM-DD形式、オプション）
- **成功レスポンス（200 OK）**:
```typescript
{
  success: true,
  data: {
    importId: string,              // インポートID
    stockCode: string,             // 銘柄コード
    stockName: string,             // 銘柄名
    totalRows: number,             // 総行数
    successCount: number,          // 成功件数
    skipCount: number,             // スキップ件数
    errorCount: number,            // エラー件数
    errors: [                      // エラー詳細
      {
        row: number,               // 行番号
        publishedAt: string,       // 公開日時
        title: string,             // タイトル
        message: string            // エラーメッセージ
      }
    ],
    importedAt: string             // インポート日時（ISO 8601形式）
  }
}
```

### 3.5 CSVフォーマットバリデーション

#### 処理概要
CSVファイルの形式とデータ内容をバリデーションする。

#### バリデーションルール

**ヘッダー行**:
- 必須ヘッダー: `publishedAt,title,summary,url,source,sentiment,sentimentScore`
- `summary`, `url`, `source`, `sentiment`, `sentimentScore`は任意項目（値が空でも可）
- 大文字小文字を区別しない
- ヘッダー行が不正な場合、エラー「CSVヘッダーが不正です」

**データ行**:

1. **公開日時（publishedAt）**:
   - 形式: YYYY-MM-DD HH:MM:SS（例: 2024-01-15 10:30:00）またはISO 8601形式
   - 有効な日時であること
   - 未来の日時は不可
   - 1900年以前の日時は不可
   - エラー例: 「公開日時の形式が不正です（YYYY-MM-DD HH:MM:SS形式またはISO 8601形式で入力してください）」

2. **タイトル（title）**:
   - 必須項目
   - 255文字以内
   - エラー例: 「タイトルは必須です」

3. **要約（summary）**:
   - 任意項目
   - 長さ制限なし（TEXT型）

4. **URL（url）**:
   - 任意項目
   - 500文字以内
   - http://またはhttps://で始まる必要がある
   - エラー例: 「URLはhttp://またはhttps://で始まる必要があります」

5. **ソース（source）**:
   - 任意項目
   - 100文字以内
   - エラー例: 「ソースは100文字以内で入力してください」

6. **センチメント（sentiment）**:
   - 任意項目
   - 値: `positive`, `negative`, `neutral`のいずれか
   - デフォルト: `neutral`
   - エラー例: 「センチメントはpositive、negative、neutralのいずれかである必要があります」

7. **センチメントスコア（sentimentScore）**:
   - 任意項目
   - 範囲: -1.00〜1.00
   - 小数点第2位まで
   - エラー例: 「センチメントスコアは-1.00〜1.00の範囲内である必要があります」

### 3.6 重複データ処理

#### 処理概要
既存データとの重複が発生した場合、選択された戦略に応じて処理を実行する。

#### 重複判定
- **重複キー**: `stockId` + `publishedAt` + `title`（銘柄ID、公開日時、タイトルの組み合わせ）

#### 処理戦略

**スキップ（skip）**:
1. 既存データの存在チェック（銘柄ID、公開日時、タイトルでの一致確認）
2. 重複が検出された場合、その行をスキップ
3. スキップ件数をカウント
4. 新規データのみデータベースに挿入
5. 結果に`skipCount`を含めて返す

**上書き（overwrite）**:
1. 既存データの存在チェック
2. 重複が検出された場合、既存データを更新（UPSERT）
3. 新規データの場合は挿入
4. 更新件数を成功件数にカウント
5. 結果に`successCount`を含めて返す

### 3.7 重複チェック処理

#### 処理概要
インポート実行前に、CSVファイル内のニュースが既存データと重複しているかを事前に確認する。

#### 処理フロー
1. ユーザーが「重複チェック」ボタンをクリック
2. CSVファイルをパース
3. `POST /api/v1/stocks/:stockCode/news/check-duplicates` APIを呼び出し
4. サーバーで重複チェックを実行
5. 重複チェック結果を画面に表示:
   - 総ニュース数
   - 重複件数
   - 重複ニュース一覧（公開日時、タイトル、既存ニュースID）
6. ユーザーは重複情報を確認してからインポートを実行可能

#### データ送信API
- **エンドポイント**: `POST /api/v1/stocks/:stockCode/news/check-duplicates`
- **リクエストボディ**:
```typescript
{
  news: [
    {
      publishedAt: string,
      title: string
    }
  ]
}
```
- **成功レスポンス（200 OK）**:
```typescript
{
  success: true,
  data: {
    totalNews: number,             // 総ニュース数
    duplicateCount: number,        // 重複件数
    duplicates: [                  // 重複ニュース詳細
      {
        publishedAt: string,       // 公開日時
        title: string,             // タイトル
        existingNewsId: number     // 既存ニュースID
      }
    ]
  }
}
```

### 3.8 日付範囲フィルター処理

#### 処理概要
CSVファイルから特定期間のニュースのみをインポート対象として抽出する。

#### 処理フロー
1. ユーザーが開始日・終了日を入力（オプション）
2. CSVファイルをパース後、日付範囲フィルターを適用
3. `publishedAt`が開始日以降かつ終了日以前のニュースのみを抽出
4. フィルター適用後の件数を表示
5. フィルターされたニュースのみをバリデーション・インポート対象とする

#### フィルター条件
- **開始日のみ指定**: 開始日以降のニュース
- **終了日のみ指定**: 終了日以前のニュース
- **両方指定**: 開始日以降かつ終了日以前のニュース
- **両方未指定**: 全てのニュース

### 3.9 キャンセル処理

#### 処理概要
ユーザーがキャンセルボタンをクリックすると、入力内容をクリアし、初期状態に戻す。

#### 処理フロー
1. ユーザーがキャンセルボタンをクリック
2. 銘柄コード入力欄をクリア
3. ファイル選択をクリア
4. 日付範囲フィルターをクリア
5. 重複データ処理を「スキップ」にリセット
6. 進捗表示をクリア
7. 結果表示をクリア
8. エラー表示をクリア
9. インポート実行ボタンを無効化

### 3.10 リセット処理

#### 処理概要
インポート完了後、新たなインポートを開始するために状態をリセットする。

#### 処理フロー
1. ユーザーが「新しいインポートを開始」ボタンをクリック
2. 進捗表示をクリア（idle状態に戻す）
3. 結果表示をクリア
4. 重複チェック結果をクリア
5. エラー表示をクリア
6. 入力内容は保持（銘柄コード、ファイル選択、日付範囲、重複戦略）

---

## 4. エラーハンドリング

### 4.1 エラー種別

| エラー種別 | HTTPステータス | 表示メッセージ | 対応 |
|-----------|--------------|---------------|------|
| ファイル未選択 | - | 「CSVファイルを選択してください」 | フロントエンドバリデーション、インポート実行をブロック |
| ファイルサイズ超過 | 400 Bad Request | 「ファイルサイズが5MBを超えています」 | ファイル選択時にエラー表示、インポート実行をブロック |
| 不正なファイル形式 | 415 Unsupported Media Type | 「CSVファイル(.csv)のみアップロード可能です」 | サーバーレスポンスでエラー表示 |
| CSVヘッダー不正 | 400 Bad Request | 「CSVヘッダーが不正です」 | サーバーレスポンスでエラー表示 |
| CSV形式エラー | 400 Bad Request | 「CSVファイルの形式が不正です」 | サーバーレスポンスでエラー表示 |
| 銘柄が見つからない | 404 Not Found | 「銘柄コード XXXX が見つかりません」 | 銘柄コード入力時またはインポート実行時にエラー表示 |
| バリデーションエラー（全行無効） | - | 「バリデーションエラーが発生しました:\n行X: メッセージ\n...」 | フロントエンドバリデーションでエラー表示、処理を中断 |
| データ無し | - | 「CSVファイルにデータが含まれていません」 | フロントエンドバリデーションでエラー表示、処理を中断 |
| 日付範囲不正 | - | 「開始日は終了日より前である必要があります」 | 日付入力時にエラー表示 |
| サーバーエラー | 500 Internal Server Error | 「ニュースデータのインポートに失敗しました」 | サーバーレスポンスでエラー表示、リトライ可能 |
| ネットワークエラー | - | 「インポート中にエラーが発生しました」 | ネットワークエラー表示、リトライ可能 |

### 4.2 エラー処理フロー

1. 処理中にエラーが発生
2. エラーの種類を判定:
   - フロントエンドバリデーションエラー
   - APIエラー（HTTPステータスコード）
   - ネットワークエラー
3. エラー種別に応じた処理を実行:
   - **フロントエンドバリデーションエラー**:
     - 進捗バーを非表示
     - エラーメッセージを赤色で表示
     - 処理を中断
   - **INVALID_CSV_FORMAT (400)**:
     - 進捗バーを非表示
     - エラーメッセージを表示: `error.message`
     - 処理を中断
   - **STOCK_NOT_FOUND (404)**:
     - 進捗バーを非表示
     - エラーメッセージを表示: 「銘柄コード XXXX が見つかりません」
     - 処理を中断
   - **INTERNAL_SERVER_ERROR (500)**:
     - 進捗バーを非表示
     - エラーメッセージを表示: 「ニュースデータのインポートに失敗しました」
     - リトライボタンを表示
   - **ネットワークエラー**:
     - 進捗バーを非表示
     - エラーメッセージを表示: 「インポート中にエラーが発生しました」
     - リトライボタンを表示
4. コンソールに詳細なエラーログを出力（開発者向け）

### 4.3 部分的なエラーの処理

#### シナリオ
CSVファイル内の一部の行にバリデーションエラーがあるが、有効な行も存在する場合。

#### 処理フロー
1. フロントエンドバリデーションで有効な行と無効な行を分離
2. 有効な行が1行以上ある場合、インポート処理を継続
3. 警告メッセージを表示: 「X件のバリデーションエラーがありました。Y件の有効なデータをインポートします。」
4. サーバーへ有効な行のみをアップロード
5. インポート結果でエラー詳細を表示:
   - エラー件数
   - エラー一覧テーブル（行番号、公開日時、タイトル、エラーメッセージ）
6. ユーザーはエラー行を確認し、修正してから再インポート可能

### 4.4 エラーレスポンス例

#### ファイル形式エラー（415）
```typescript
{
  success: false,
  error: {
    code: "UNSUPPORTED_FILE_TYPE",
    message: "CSVファイル(.csv)のみアップロード可能です"
  }
}
```

#### CSVヘッダーエラー（400）
```typescript
{
  success: false,
  error: {
    code: "INVALID_CSV_FORMAT",
    message: "CSVヘッダーが不正です。必須ヘッダー: publishedAt,title,summary,url,source,sentiment,sentimentScore"
  }
}
```

#### 銘柄が見つからない（404）
```typescript
{
  success: false,
  error: {
    code: "STOCK_NOT_FOUND",
    message: "銘柄コード 7203 が見つかりません"
  }
}
```

#### サーバーエラー（500）
```typescript
{
  success: false,
  error: {
    code: "INTERNAL_SERVER_ERROR",
    message: "ニュースデータのインポートに失敗しました"
  }
}
```

---

## 5. CSVファイルフォーマット

### 5.1 ファイル形式

- **文字コード**: UTF-8
- **区切り文字**: カンマ（`,`）
- **改行コード**: LF（`\n`）またはCRLF（`\r\n`）
- **ヘッダー行**: 必須（1行目）

### 5.2 ヘッダー行

```csv
publishedAt,title,summary,url,source,sentiment,sentimentScore
```

### 5.3 データ行の形式

```csv
2024-01-15 10:30:00,トヨタ自動車が新型EV発表,トヨタ自動車は新型電気自動車を発表しました。,https://example.com/news/1,日経新聞,positive,0.85
2024-01-16 14:20:00,自動車業界の半導体不足が深刻化,半導体不足により生産調整を実施。,,Bloomberg,negative,-0.60
```

### 5.4 サンプルCSVファイル

```csv
publishedAt,title,summary,url,source,sentiment,sentimentScore
2024-01-15 10:30:00,トヨタ自動車が新型EV発表,トヨタ自動車は新型電気自動車を発表しました。2025年から量産開始予定。,https://example.com/news/toyota-ev,日経新聞,positive,0.85
2024-01-16 14:20:00,自動車業界の半導体不足が深刻化,半導体不足により自動車メーカー各社が生産調整を実施。在庫減少が懸念される。,https://example.com/news/chip-shortage,Bloomberg,negative,-0.60
2024-01-17 09:00:00,トヨタの第3四半期決算発表,トヨタ自動車が第3四半期の決算を発表。売上高は前年同期比5%増。,https://example.com/news/toyota-q3,ロイター,neutral,0.10
2024-01-18 16:45:00,電気自動車の販売台数が過去最高,2024年の電気自動車販売台数が過去最高を記録。環境意識の高まりが背景。,https://example.com/news/ev-sales,日経新聞,positive,0.70
```

### 5.5 注意事項

- 日時は昇順または降順どちらでも可
- 任意項目（summary, url, source, sentiment, sentimentScore）は空欄でも可
- センチメントのデフォルト値は`neutral`
- センチメントスコアは-1.00〜1.00の範囲（小数点第2位まで）
- タイトルに改行やカンマが含まれる場合、ダブルクォートで囲む必要がある
- 空行は無視される
- コメント行（`#`で始まる行）は非対応
