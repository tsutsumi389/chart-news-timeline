# 株価インポート画面仕様書

## 1. 画面概要

CSVファイルから株価データ（OHLC + 出来高）を一括インポートする画面。銘柄コードを指定してCSVファイルをアップロードし、バリデーション後にデータベースへ登録する。重複データの処理方法（スキップ/上書き）を選択可能。

### 1.1 画面URL
- パス: `/import`

### 1.2 画面イメージ

（画面モックアップは実装時に追加予定）

---

## 2. 画面項目定義

### 2.1 ヘッダーエリア

| 項目名 | 種別 | 説明 |
|--------|------|------|
| 画面タイトル | テキスト | 「株価データインポート」を表示 |
| 説明テキスト | テキスト | 「CSVファイルから株価データを一括登録します」 |

### 2.2 インポート設定エリア

#### 2.2.1 銘柄選択

| 項目名 | 種別 | 説明 |
|--------|------|------|
| 銘柄コード入力欄 | テキスト入力 | 4桁の数字の銘柄コードを入力（例: 7203） |
| 銘柄情報表示 | テキスト | 入力された銘柄コードに対応する銘柄名を表示<br>例: 「7203 - トヨタ自動車」 |
| バリデーションエラー表示 | エラーテキスト | 銘柄コードが不正または見つからない場合にエラーメッセージを表示 |

#### 2.2.2 ファイル選択

| 項目名 | 種別 | 説明 |
|--------|------|------|
| ファイル選択ボタン | ファイル入力 | CSVファイルを選択するボタン<br>受け入れ形式: `.csv`<br>最大サイズ: 10MB |
| 選択ファイル名表示 | テキスト | 選択されたファイル名を表示 |
| ファイル形式説明 | ヘルプテキスト | 「CSV形式: date,open,high,low,close,volume」 |
| CSVフォーマット例 | コード | 正しいCSVフォーマットの例を表示 |

#### 2.2.3 重複データ処理設定

| 項目名 | 種別 | 説明 |
|--------|------|------|
| 処理方法選択 | ラジオボタン | 重複データの処理方法を選択<br>・スキップ（skip）: 既存データを保持、新規データのみ登録<br>・上書き（overwrite）: 既存データを更新 |
| デフォルト値 | - | 「スキップ」を初期選択 |
| 説明テキスト | ヘルプテキスト | 各選択肢の動作説明を表示 |

### 2.3 アクションボタンエリア

| 項目名 | 種別 | 説明 |
|--------|------|------|
| インポート実行ボタン | ボタン（primary） | CSVファイルのアップロードとインポート処理を実行<br>銘柄コードとファイルが未入力の場合は無効化 |
| キャンセルボタン | ボタン | 入力内容をクリアし、初期状態に戻す |

### 2.4 進捗表示エリア

| 項目名 | 種別 | 説明 |
|--------|------|------|
| 進捗バー | プログレスバー | インポート処理の進捗を0〜100%で表示<br>段階: パース(10%)→バリデーション(30%)→アップロード(60%)→完了(100%) |
| ステータスメッセージ | テキスト | 現在の処理ステータスを表示<br>例: 「CSVファイルをパースしています...」 |
| 処理中スピナー | スピナー | 処理実行中はスピナーアイコンを表示 |

### 2.5 結果表示エリア

#### 2.5.1 インポート成功時

| 項目名 | 種別 | 説明 |
|--------|------|------|
| 成功メッセージ | 成功通知 | 「インポートが完了しました」を緑色で表示 |
| インポートID | テキスト | 一意のインポートID（例: `import_20240115123456_a1b2c3d4`） |
| 銘柄情報 | テキスト | 銘柄コードと銘柄名 |
| 総行数 | 数値 | CSVファイルの総データ行数 |
| 成功件数 | 数値（緑） | データベースに登録成功した件数 |
| スキップ件数 | 数値（黄） | 重複によりスキップされた件数（skip戦略時のみ） |
| エラー件数 | 数値（赤） | バリデーションエラーまたは登録エラーの件数 |
| インポート日時 | 日時 | インポート実行日時（ISO 8601形式） |

#### 2.5.2 エラー詳細

| 項目名 | 種別 | 説明 |
|--------|------|------|
| エラー一覧テーブル | テーブル | エラーが発生した行の詳細情報を表示<br>列: 行番号、日付、エラーメッセージ |
| エラー件数表示 | テキスト | 「エラー: X件」と表示 |
| エラーの折りたたみ | アコーディオン | エラー件数が多い場合、初期状態では折りたたみ表示 |

### 2.6 状態表示

| 項目名 | 種別 | 説明 |
|--------|------|------|
| ローディング表示 | スピナー/プログレスバー | 処理実行中は進捗バーとステータスメッセージを表示 |
| エラー表示 | エラーメッセージ | API通信エラーやファイル形式エラーを赤色で表示 |
| 警告表示 | 警告メッセージ | 一部データにエラーがある場合、黄色で警告を表示 |

---

## 3. 操作処理詳細

### 3.1 初期表示処理

#### 処理概要
画面表示時にフォームを初期化し、インポート設定入力欄を表示する。

#### 処理フロー
1. 画面マウント時にフォームステートを初期化
2. 銘柄コード入力欄を空に設定
3. ファイル選択を未選択に設定
4. 重複データ処理を「スキップ」に設定（デフォルト）
5. 進捗表示とエラー表示をクリア
6. フォームを表示

### 3.2 銘柄コード入力処理

#### 処理概要
ユーザーが銘柄コードを入力すると、リアルタイムでバリデーションを実行し、対応する銘柄情報を取得して表示する。

#### 処理フロー
1. ユーザーが銘柄コード入力欄に4桁の数字を入力
2. 入力値のバリデーション:
   - 4桁の数字形式チェック（正規表現: `/^\d{4}$/`）
   - 形式が不正な場合、エラーメッセージ「銘柄コードは4桁の数字である必要があります」を表示
3. 形式が正しい場合、`GET /api/v1/stocks/:stockCode` APIを呼び出し
4. 銘柄が存在する場合:
   - 銘柄名を取得し、「7203 - トヨタ自動車」形式で表示
   - インポート実行ボタンを有効化（ファイルも選択済みの場合）
5. 銘柄が見つからない場合:
   - エラーメッセージ「銘柄コード XXXX が見つかりません」を表示
   - インポート実行ボタンを無効化

#### データ取得API
- **エンドポイント**: `GET /api/v1/stocks/:stockCode`
- **成功レスポンス（200 OK）**:
```typescript
{
  success: true,
  data: {
    stockId: number,
    stockCode: string,
    stockName: string,
    createdAt: string,
    updatedAt: string
  }
}
```

### 3.3 ファイル選択処理

#### 処理概要
ユーザーがCSVファイルを選択すると、ファイル名を表示し、簡易的なバリデーションを実行する。

#### 処理フロー
1. ユーザーがファイル選択ボタンをクリック
2. ファイル選択ダイアログを表示（`.csv`ファイルのみフィルタ）
3. ファイルが選択された場合:
   - ファイル名を画面に表示
   - ファイルサイズをチェック（10MB以下）
   - ファイル拡張子をチェック（`.csv`）
   - バリデーション失敗時はエラーメッセージを表示
4. ファイル選択成功時、インポート実行ボタンを有効化（銘柄コードも入力済みの場合）

#### バリデーション
- **ファイルサイズ**: 10MB以下
- **ファイル形式**: `.csv`拡張子
- **MIMEタイプ**: `text/csv`, `text/plain`, `application/octet-stream`

### 3.4 インポート実行処理

#### 処理概要
ユーザーがインポート実行ボタンをクリックすると、CSVファイルをパース・バリデーション後、サーバーにアップロードしてデータベースへ登録する。

#### 処理フロー

**ステップ1: CSVファイルパース（進捗: 0% → 10%）**
1. インポート実行ボタンをクリック
2. 進捗バーを表示（0%）
3. ステータスメッセージ「CSVファイルを読み込んでいます...」を表示
4. CSVファイルを読み込み、パース処理を実行
5. ヘッダー行のチェック（`date,open,high,low,close,volume`）
6. データ行を配列に変換
7. 進捗を10%に更新

**ステップ2: フロントエンドバリデーション（進捗: 10% → 30%）**
1. ステータスメッセージ「X件のデータをバリデーションしています...」を表示
2. 各行のバリデーション:
   - 日付形式チェック（YYYY-MM-DD）
   - 価格の正数チェック
   - OHLC関係性チェック（高値 ≥ 始値/終値 ≥ 安値）
   - 出来高チェック（0以上の整数）
3. バリデーション結果を集計
4. 全行が無効な場合、エラーメッセージを表示して処理を中断
5. 一部の行のみ有効な場合、警告を表示して処理を継続
6. 進捗を30%に更新

**ステップ3: サーバーへアップロード（進捗: 30% → 60%）**
1. ステータスメッセージ「サーバーにアップロードしています...」を表示
2. `POST /api/v1/stocks/:stockCode/import/csv` APIを呼び出し
3. multipart/form-dataでCSVファイルと重複戦略を送信
4. サーバー側でバリデーションとデータベース登録を実行
5. 進捗を60%に更新

**ステップ4: 完了処理（進捗: 60% → 100%）**
1. APIレスポンスを受信
2. インポート結果を結果表示エリアに表示
3. 進捗を100%に更新
4. ステータスメッセージ「インポートが完了しました」を表示
5. 成功メッセージを緑色で表示

#### データ送信API
- **エンドポイント**: `POST /api/v1/stocks/:stockCode/import/csv`
- **リクエスト形式**: `multipart/form-data`
- **リクエストボディ**:
  - `file`: CSVファイル（バイナリ）
  - `duplicateStrategy`: 'skip' | 'overwrite'（オプション、デフォルト: 'skip'）
- **成功レスポンス（200 OK）**:
```typescript
{
  success: true,
  data: {
    importId: string,              // インポートID
    stockCode: string,             // 銘柄コード
    stockName: string,             // 銘柄名
    totalRows: number,             // 総行数
    successCount: number,          // 成功件数
    skipCount: number,             // スキップ件数
    errorCount: number,            // エラー件数
    errors: [                      // エラー詳細
      {
        row: number,               // 行番号
        date: string,              // 日付
        message: string            // エラーメッセージ
      }
    ],
    importedAt: string             // インポート日時（ISO 8601形式）
  }
}
```

### 3.5 CSVフォーマットバリデーション

#### 処理概要
CSVファイルの形式とデータ内容をバリデーションする。

#### バリデーションルール

**ヘッダー行**:
- 必須ヘッダー: `date,open,high,low,close,volume`
- 大文字小文字を区別しない
- ヘッダー行が不正な場合、エラー「CSVヘッダーが不正です」

**データ行**:

1. **日付（date）**:
   - 形式: YYYY-MM-DD（例: 2024-01-15）
   - 有効な日付であること（2月30日などは不可）
   - 未来の日付は不可
   - 1900年以前の日付は不可
   - エラー例: 「日付形式が不正です（YYYY-MM-DD形式で入力してください）」

2. **始値（open）**:
   - 正の数値であること
   - エラー例: 「始値は正の数値である必要があります」

3. **高値（high）**:
   - 正の数値であること
   - 始値・終値・安値以上であること
   - エラー例: 「高値が終値より低い値です」

4. **安値（low）**:
   - 正の数値であること
   - 始値・終値・高値以下であること
   - エラー例: 「安値が始値より高い値です」

5. **終値（close）**:
   - 正の数値であること
   - エラー例: 「終値は正の数値である必要があります」

6. **出来高（volume）**:
   - 0以上の整数であること
   - 1兆株以下であること
   - エラー例: 「出来高は整数である必要があります」

7. **OHLC関係性**:
   - 高値 ≥ 始値, 終値, 安値
   - 安値 ≤ 始値, 終値, 高値
   - 1日の値動きが平均価格の50%以下（異常値検出）
   - エラー例: 「1日の値動きが異常に大きいです（データを確認してください）」

### 3.6 重複データ処理

#### 処理概要
既存データとの重複が発生した場合、選択された戦略に応じて処理を実行する。

#### 重複判定
- **重複キー**: `stockId` + `tradeDate`（銘柄IDと取引日の組み合わせ）

#### 処理戦略

**スキップ（skip）**:
1. 既存データの存在チェック
2. 重複が検出された場合、その行をスキップ
3. スキップ件数をカウント
4. 新規データのみデータベースに挿入
5. 結果に`skipCount`を含めて返す

**上書き（overwrite）**:
1. 既存データの存在チェック
2. 重複が検出された場合、既存データを更新（UPSERT）
3. 新規データの場合は挿入
4. 更新件数を成功件数にカウント
5. 結果に`successCount`を含めて返す

### 3.7 キャンセル処理

#### 処理概要
ユーザーがキャンセルボタンをクリックすると、入力内容をクリアし、初期状態に戻す。

#### 処理フロー
1. ユーザーがキャンセルボタンをクリック
2. 銘柄コード入力欄をクリア
3. ファイル選択をクリア
4. 重複データ処理を「スキップ」にリセット
5. 進捗表示をクリア
6. 結果表示をクリア
7. エラー表示をクリア
8. インポート実行ボタンを無効化

### 3.8 リセット処理

#### 処理概要
インポート完了後、新たなインポートを開始するために状態をリセットする。

#### 処理フロー
1. ユーザーが「新しいインポートを開始」ボタンをクリック
2. 進捗表示をクリア（idle状態に戻す）
3. 結果表示をクリア
4. エラー表示をクリア
5. 入力内容は保持（銘柄コード、ファイル選択、重複戦略）

---

## 4. エラーハンドリング

### 4.1 エラー種別

| エラー種別 | HTTPステータス | 表示メッセージ | 対応 |
|-----------|--------------|---------------|------|
| ファイル未選択 | - | 「CSVファイルを選択してください」 | フロントエンドバリデーション、インポート実行をブロック |
| ファイルサイズ超過 | 400 Bad Request | 「ファイルサイズが10MBを超えています」 | ファイル選択時にエラー表示、インポート実行をブロック |
| 不正なファイル形式 | 415 Unsupported Media Type | 「CSVファイルのみサポートしています」 | サーバーレスポンスでエラー表示 |
| CSVヘッダー不正 | 400 Bad Request | 「CSVヘッダーが不正です」 | サーバーレスポンスでエラー表示 |
| CSV形式エラー | 400 Bad Request | 「CSVファイルの形式が不正です」 | サーバーレスポンスでエラー表示 |
| 銘柄が見つからない | 404 Not Found | 「銘柄コード XXXX が見つかりません」 | 銘柄コード入力時またはインポート実行時にエラー表示 |
| バリデーションエラー（全行無効） | - | 「バリデーションエラーが発生しました:\n行X: メッセージ\n...」 | フロントエンドバリデーションでエラー表示、処理を中断 |
| データ無し | - | 「CSVファイルにデータが含まれていません」 | フロントエンドバリデーションでエラー表示、処理を中断 |
| サーバーエラー | 500 Internal Server Error | 「CSVインポートに失敗しました」 | サーバーレスポンスでエラー表示、リトライ可能 |
| ネットワークエラー | - | 「インポート中にエラーが発生しました」 | ネットワークエラー表示、リトライ可能 |

### 4.2 エラー処理フロー

1. 処理中にエラーが発生
2. エラーの種類を判定:
   - フロントエンドバリデーションエラー
   - APIエラー（HTTPステータスコード）
   - ネットワークエラー
3. エラー種別に応じた処理を実行:
   - **フロントエンドバリデーションエラー**:
     - 進捗バーを非表示
     - エラーメッセージを赤色で表示
     - 処理を中断
   - **INVALID_CSV_FORMAT (400)**:
     - 進捗バーを非表示
     - エラーメッセージを表示: `error.message`
     - 処理を中断
   - **STOCK_NOT_FOUND (404)**:
     - 進捗バーを非表示
     - エラーメッセージを表示: 「銘柄コード XXXX が見つかりません」
     - 処理を中断
   - **INTERNAL_SERVER_ERROR (500)**:
     - 進捗バーを非表示
     - エラーメッセージを表示: 「CSVインポートに失敗しました」
     - リトライボタンを表示
   - **ネットワークエラー**:
     - 進捗バーを非表示
     - エラーメッセージを表示: 「インポート中にエラーが発生しました」
     - リトライボタンを表示
4. コンソールに詳細なエラーログを出力（開発者向け）

### 4.3 部分的なエラーの処理

#### シナリオ
CSVファイル内の一部の行にバリデーションエラーがあるが、有効な行も存在する場合。

#### 処理フロー
1. フロントエンドバリデーションで有効な行と無効な行を分離
2. 有効な行が1行以上ある場合、インポート処理を継続
3. 警告メッセージを表示: 「X件のバリデーションエラーがありました。Y件の有効なデータをインポートします。」
4. サーバーへ有効な行のみをアップロード
5. インポート結果でエラー詳細を表示:
   - エラー件数
   - エラー一覧テーブル（行番号、日付、エラーメッセージ）
6. ユーザーはエラー行を確認し、修正してから再インポート可能

### 4.4 エラーレスポンス例

#### ファイル形式エラー（415）
```typescript
{
  success: false,
  error: {
    code: "UNSUPPORTED_FILE_TYPE",
    message: "CSVファイルのみサポートしています"
  }
}
```

#### CSVヘッダーエラー（400）
```typescript
{
  success: false,
  error: {
    code: "INVALID_CSV_FORMAT",
    message: "CSVヘッダーが不正です。必須ヘッダー: date,open,high,low,close,volume"
  }
}
```

#### 銘柄が見つからない（404）
```typescript
{
  success: false,
  error: {
    code: "STOCK_NOT_FOUND",
    message: "銘柄コード 7203 が見つかりません"
  }
}
```

#### サーバーエラー（500）
```typescript
{
  success: false,
  error: {
    code: "INTERNAL_SERVER_ERROR",
    message: "CSVインポートに失敗しました"
  }
}
```

---

## 5. CSVファイルフォーマット

### 5.1 ファイル形式

- **文字コード**: UTF-8
- **区切り文字**: カンマ（`,`）
- **改行コード**: LF（`\n`）またはCRLF（`\r\n`）
- **ヘッダー行**: 必須（1行目）

### 5.2 ヘッダー行

```csv
date,open,high,low,close,volume
```

### 5.3 データ行の形式

```csv
2024-01-15,1500.00,1550.00,1480.00,1530.00,1000000
2024-01-16,1530.00,1580.00,1520.00,1570.00,1200000
```

### 5.4 サンプルCSVファイル

```csv
date,open,high,low,close,volume
2024-01-15,1500.00,1550.00,1480.00,1530.00,1000000
2024-01-16,1530.00,1580.00,1520.00,1570.00,1200000
2024-01-17,1570.00,1600.00,1560.00,1590.00,1100000
2024-01-18,1590.00,1620.00,1575.00,1610.00,1300000
2024-01-19,1610.00,1650.00,1600.00,1630.00,1400000
```

### 5.5 注意事項

- 日付は昇順または降順どちらでも可
- 価格は小数点第2位まで（例: 1500.00）
- 出来高は整数のみ
- 空行は無視される
- コメント行（`#`で始まる行）は非対応
