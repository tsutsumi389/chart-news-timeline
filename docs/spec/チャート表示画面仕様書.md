# チャート表示画面仕様書

## 1. 画面概要

株価のローソク足チャートとニュース情報を統合表示するインタラクティブなチャート画面。
ユーザーは株価の値動きとニュースイベントの関連性を視覚的に把握できる。

### 1.1 画面URL
- サンプルデータ表示: `/`
- 銘柄別チャート: `/chart/:stockCode`

### 1.2 画面イメージ

![チャート表示画面](./images/chart-display.png)

---

## 2. 画面項目定義

### 2.1 ヘッダー部

| 項目名 | 種別 | 説明 |
|--------|------|------|
| ページタイトル | テキスト | "株価ローソク足チャート" または "株価チャート" を表示 |
| 銘柄コード表示 | テキスト | 選択中の銘柄コード（例: `7203`）を表示 |
| ページ説明 | テキスト | チャートの簡単な説明文を表示（サンプルデータ表示時のみ） |

### 2.2 操作エリア

| 項目名 | 種別 | 説明 |
|--------|------|------|
| 戻るボタン | ボタン | 株一覧画面へ遷移するボタン（銘柄別チャート表示時のみ） |
| 再試行ボタン | ボタン | エラー発生時にデータを再取得するボタン |

### 2.3 チャート表示エリア

#### 2.3.1 チャート全体

| 項目名 | 種別 | 説明 |
|--------|------|------|
| チャートタイトル | テキスト | "株価ローソク足チャート with ニュース" |
| チャート領域 | グラフ | Apache EChartsによるインタラクティブチャート<br>高さ: 600px（デフォルト）、幅: 100% |
| 凡例 | 選択式凡例 | "株価"/"ニュース" の表示・非表示を切り替え可能 |

#### 2.3.2 ローソク足チャート

| 項目名 | 種別 | 説明 |
|--------|------|------|
| X軸（日付） | カテゴリ軸 | 取引日を `M/D` 形式で表示（例: `1/15`） |
| Y軸（価格） | 数値軸 | 株価（自動スケール調整） |
| 陽線 | ローソク足 | 終値 > 始値の場合<br>色: `#26A69A`（緑） |
| 陰線 | ローソク足 | 終値 < 始値の場合<br>色: `#EF5350`（赤） |
| ツールチップ | ホバー表示 | ローソク足にマウスオーバーで表示<br>・日付<br>・始値<br>・終値<br>・安値<br>・高値 |

#### 2.3.3 ニュースマーカー

| 項目名 | 種別 | 説明 |
|--------|------|------|
| ニュースマーカー | 散布図 | その日の高値位置にマーカーを表示<br>サイズ: 12px |
| センチメント表示 | 色分け | ・ポジティブ: `#4CAF50`（緑）<br>・ネガティブ: `#F44336`（赤）<br>・中立: `#9E9E9E`（グレー） |
| 通常時ラベル | 吹き出し | ニュースタイトルの短縮版（15文字まで）<br>センチメント色の背景、白文字<br>フォントサイズ: 11px、太字 |
| ホバー時ラベル | 拡張吹き出し | 以下の詳細情報を表示:<br>・ニュースタイトル（全文）<br>・日付と時刻<br>・要約（ある場合）<br>・センチメント<br>・ニュースソース<br>幅: 280px、自動折り返し |

#### 2.3.4 ズーム機能

| 項目名 | 種別 | 説明 |
|--------|------|------|
| ホイールズーム | 操作 | マウスホイールでチャート範囲を拡大・縮小 |
| スライダーズーム | スライダー | チャート下部のスライダーで表示範囲を調整<br>位置: bottom 5%<br>高さ: 30px<br>初期表示範囲: 0-100% |

### 2.4 状態表示

| 項目名 | 種別 | 説明 |
|--------|------|------|
| ローディング表示 | テキスト | "読み込み中..." メッセージを表示 |
| エラー表示 | エラーメッセージ | エラー内容と再試行ボタンを表示<br>背景色: エラーカラー（赤系） |
| データ無し表示 | テキスト | "この銘柄の株価データがありません。" メッセージを表示 |

---

## 3. 操作処理詳細

### 3.1 画面初期表示処理

#### 処理概要
銘柄コードに基づいて株価データをバックエンドから取得し、チャートを初期描画する。

#### 処理フロー
1. URLパラメータから銘柄コードを取得
2. 銘柄コードが存在しない場合、エラーメッセージを表示して終了
3. 銘柄コードが存在する場合、ローディング状態を表示
4. バックエンドAPIを呼び出して株価データを取得
5. データ取得成功時、チャートを描画
6. データ取得失敗時、エラーメッセージを表示

#### データ取得API
- **エンドポイント**: `GET /api/stock-prices/:stockCode`
- **レスポンス形式**:
```typescript
{
  success: boolean;
  data: CandlestickData[];
}
```

### 3.2 チャート描画処理

#### 処理概要
取得した株価データとニュースデータをチャートライブラリが理解できる形式に変換し、インタラクティブなチャートを描画する。

#### 処理フロー
1. チャートの描画インスタンスを初期化
2. 株価データを日付配列と値配列に分解
   - 日付配列: すべての取引日
   - 値配列: 各日の [始値, 終値, 安値, 高値] のセット
3. ニュースデータが存在する場合、散布図用のデータに変換
   - 各ニュースの表示位置を計算（その日の高値）
   - センチメントに応じた色を設定
   - ラベル情報（通常時・ホバー時）を設定
4. チャート全体の設定を生成（軸、凡例、ツールチップなど）
5. チャートを描画

#### データ変換ロジック
- **株価データ**: [始値, 終値, 安値, 高値] 形式の配列に変換
- **ニュースデータ**: 座標値（日付, 価格）とメタ情報を含むオブジェクトに変換

### 3.3 リサイズ処理

#### 処理概要
ブラウザウィンドウのサイズ変更に追従してチャートを再描画する。

#### 処理フロー
1. ウィンドウのリサイズイベントを監視
2. リサイズが発生したら、チャートのサイズを再計算
3. チャートを新しいサイズで再描画

#### クリーンアップ
- 画面を離れる際、イベント監視を停止
- チャートインスタンスを破棄してメモリを解放

### 3.4 ツールチップ表示処理（ローソク足）

#### 処理概要
ユーザーがローソク足にマウスカーソルを合わせたとき、その日の株価詳細情報をポップアップ表示する。

#### 処理フロー
1. ユーザーがローソク足にマウスオーバー
2. カーソル位置の日付とデータを特定
3. 以下の情報を整形してツールチップとして表示:
   - 日付
   - 始値
   - 終値
   - 安値
   - 高値
4. マウスアウトでツールチップを非表示

#### 表示条件
- 株価シリーズの場合のみツールチップを表示
- ニュースシリーズの場合は吹き出しで表示するため、ツールチップは非表示

### 3.5 ニュース吹き出し表示処理

#### 処理概要（通常時）
ニュースマーカー上に、センチメントを色で示した短縮タイトルのラベルを常時表示する。

#### 処理フロー（通常時）
1. 各ニュースマーカーの位置にラベルを表示
2. タイトルが15文字を超える場合、15文字で切り詰めて末尾に `...` を追加
3. センチメントに応じた背景色（ポジティブ=緑、ネガティブ=赤、中立=グレー）で表示

#### 処理概要（ホバー時）
ユーザーがニュースマーカーにマウスカーソルを合わせたとき、吹き出しを拡張してニュースの詳細情報を表示する。

#### 処理フロー（ホバー時）
1. ユーザーがニュースマーカーにマウスオーバー
2. 吹き出しを拡張（幅280px）
3. 以下の詳細情報を複数行で表示:
   - ニュースタイトル（全文）
   - 日付と時刻
   - 要約（存在する場合）
   - センチメントラベル
   - ニュースソース名（存在する場合）
4. テキストが長い場合は自動的に折り返し
5. マウスアウトで通常のラベル表示に戻る

### 3.6 ズーム操作処理

#### マウスホイールズーム

##### 処理概要
チャート上でマウスホイールを操作して、表示範囲を拡大・縮小する。

##### 処理フロー
1. ユーザーがチャート上でマウスホイールを操作
2. ホイールの回転方向を検知（上=拡大、下=縮小）
3. カーソル位置を中心に表示範囲を調整
4. チャートを再描画

#### スライダーズーム

##### 処理概要
チャート下部のスライダーをドラッグして、表示する日付範囲を選択する。

##### 処理フロー
1. ユーザーがスライダーのハンドルをドラッグ
2. ハンドルの位置から表示開始位置と終了位置を計算
3. 計算した範囲のデータのみを表示
4. チャートを再描画
5. 初期状態では全データ（0-100%）を表示

### 3.7 凡例切り替え処理

#### 処理概要
ユーザーが凡例の項目をクリックして、株価またはニュースの表示・非表示を切り替える。

#### 処理フロー
1. ユーザーが凡例の「株価」または「ニュース」をクリック
2. クリックされた項目の表示状態を反転（表示⇔非表示）
3. 該当するシリーズをチャート上で表示/非表示
4. 凡例の項目スタイルを更新（表示=通常色、非表示=グレーアウト）
5. 初期状態では両方とも表示

### 3.8 戻るボタン処理

#### 処理概要
株一覧画面へ戻る。

#### 処理フロー
1. ユーザーが「← 株一覧に戻る」ボタンをクリック
2. ルーティング機能を使用して `/stocks` へ遷移
3. 株一覧画面が表示される

#### 表示条件
- 銘柄別チャート表示時（`/chart/:stockCode`）のみボタンを表示
- サンプルデータ表示時（`/`）は非表示

### 3.9 再試行ボタン処理

#### 処理概要
エラー発生時にデータ取得を再実行する。

#### 処理フロー
1. エラー発生後、ユーザーが「再試行」ボタンをクリック
2. エラー表示を一時的にクリア
3. ローディング状態を表示
4. APIを再度呼び出して株価データを取得
5. 成功時: チャートを描画
6. 失敗時: エラーメッセージを再表示

#### 表示条件
- API取得エラー発生時のみボタンを表示
- 銘柄コード未指定エラー時は非表示（再試行しても解決しないため）

---

## 4. データフォーマット

### 4.1 ローソク足データ（CandlestickData）

```typescript
interface CandlestickData {
  date: string;    // 日付 (YYYY-MM-DD)
  open: number;    // 始値
  close: number;   // 終値
  low: number;     // 安値
  high: number;    // 高値
}
```

**例**:
```json
{
  "date": "2024-01-15",
  "open": 1500,
  "close": 1520,
  "low": 1480,
  "high": 1530
}
```

### 4.2 ニュースデータ（NewsItem）

```typescript
interface NewsItem {
  id: string;                    // ニュースID
  date: string;                  // 日付 (YYYY-MM-DD)
  time?: string;                 // 時刻 (HH:mm:ss) ※オプション
  title: string;                 // ニュースタイトル
  summary?: string;              // 要約 ※オプション
  url?: string;                  // ニュース元URL ※オプション
  sentiment: 'positive' | 'negative' | 'neutral';  // センチメント
  source?: string;               // ニュースソース名 ※オプション
}
```

**例**:
```json
{
  "id": "news001",
  "date": "2024-01-15",
  "time": "09:30:00",
  "title": "新製品発表で株価上昇",
  "summary": "革新的な新製品が市場で好評価を受けています。",
  "sentiment": "positive",
  "source": "日経新聞"
}
```

### 4.3 センチメント設定

| センチメント | 色コード | ラベル |
|-------------|---------|--------|
| positive | #4CAF50 | ポジティブ |
| negative | #F44336 | ネガティブ |
| neutral | #9E9E9E | 中立 |

---

## 5. エラーハンドリング

### 5.1 エラー種別

| エラー種別 | 表示メッセージ | 対応 |
|-----------|---------------|------|
| 銘柄コード未指定 | "銘柄コードが指定されていません" | エラー表示のみ（再試行不可） |
| API取得エラー | "株価データの取得に失敗しました" | エラー表示 + 再試行ボタン |
| ネットワークエラー | API エラーメッセージ | エラー表示 + 再試行ボタン |
| データ無し | "この銘柄の株価データがありません。" | メッセージ表示のみ |

### 5.2 エラー処理フロー

1. データ取得中にエラーが発生
2. エラー内容を取得してエラーメッセージとして保持
3. ローディング状態を解除
4. エラーメッセージと再試行ボタンを表示
5. ユーザーが再試行ボタンをクリック可能

---

## 6. パフォーマンス最適化

### 6.1 レンダリング最適化

- 株価データまたはニュースデータが変更された場合のみチャートを再描画
- チャートインスタンスを再利用して初期化コストを削減
- コンポーネントが破棄される際、確実にメモリを解放

### 6.2 アニメーション設定

- ニュースマーカーは順番に表示（50ms間隔で段階的にアニメーション）
- ユーザーがニュースの出現を視覚的に追いやすくする

---

## 7. 技術仕様

### 7.1 使用ライブラリ

| ライブラリ | バージョン | 用途 |
|-----------|-----------|------|
| Apache ECharts | 最新 | チャート描画エンジン |
| React | 18.x | UIフレームワーク |
| React Router | 6.x | ルーティング |
| TypeScript | 5.x | 型安全性 |

### 7.2 対応ブラウザ

- Chrome（最新版）
- Firefox（最新版）
- Safari（最新版）
- Edge（最新版）

### 7.3 レスポンシブ対応

- **最小幅**: 768px（モバイル対応予定）
- **チャート高さ**: 600px（固定）
- **チャート幅**: 100%（親要素に追従）

---

## 8. 制約事項

1. **ニュースツールチップ**: 標準ツールチップではなく、カスタムラベル（吹き出し）で表示
2. **データ制限**: 大量データ（1000日以上）の場合、初期表示が遅延する可能性
3. **リアルタイム更新**: 現在は手動更新のみ（自動更新機能なし）
4. **ニュース表示位置**: 常にその日の高値位置に表示（価格によっては重なる可能性）

---

## 9. 今後の拡張予定

1. **日付範囲選択**: カスタム期間でのフィルタリング機能
2. **指標追加**: 移動平均線、ボリンジャーバンドなどのテクニカル指標
3. **ニュースフィルタ**: センチメント別のフィルタリング機能
4. **エクスポート**: チャートを画像として保存する機能
5. **比較表示**: 複数銘柄の同時表示機能

---

## 10. 関連ドキュメント

- [プロジェクトREADME](../../README.md)
- [CLAUDE.md - プロジェクト概要](../../CLAUDE.md)
- [株価インポート仕様書](./stock-price-import.md)
- [ニュースインポート仕様書](./news-import.md)

---

**作成日**: 2025-01-17
**最終更新日**: 2025-01-17
**バージョン**: 1.0.0
