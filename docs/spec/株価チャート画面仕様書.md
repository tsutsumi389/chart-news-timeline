# 株価チャート画面仕様書

## 1. 画面概要

特定の株銘柄の株価ローソク足チャートとニュース情報を統合表示するインタラクティブなチャート画面。ユーザーは株価の値動きとニュースイベントの関連性を視覚的に把握できる。

### 1.1 画面URL
- パス: `/chart/:stockCode`
- パラメータ: `stockCode` - 4桁の銘柄コード（例: `7203`, `AAPL`）

### 1.2 画面イメージ

（画面モックアップは実装時に追加予定）

---

## 2. 画面項目定義

### 2.1 ヘッダーエリア

| 項目名 | 種別 | 説明 |
|--------|------|------|
| 画面タイトル | テキスト | 「株価チャート」を表示 |
| 銘柄コード表示 | テキスト | 選択中の銘柄コード（例: `7203`）を表示 |
| 戻るボタン | ボタン | 株一覧画面（`/stocks`）へ遷移するボタン |

### 2.2 チャート表示エリア

#### 2.2.1 チャート全体

| 項目名 | 種別 | 説明 |
|--------|------|------|
| チャートタイトル | テキスト | 「株価ローソク足チャート with ニュース」 |
| チャート領域 | グラフ | Apache EChartsによるインタラクティブチャート<br>高さ: 600px（デフォルト）、幅: 100% |
| 凡例 | 選択式凡例 | 「株価」/「ニュース」の表示・非表示を切り替え可能<br>位置: 下部中央 |

#### 2.2.2 ローソク足チャート

| 項目名 | 種別 | 説明 |
|--------|------|------|
| X軸（日付） | カテゴリ軸 | 取引日を `M/D` 形式で表示（例: `1/15`） |
| Y軸（価格） | 数値軸 | 株価（自動スケール調整） |
| 陽線 | ローソク足 | 終値 > 始値の場合<br>色: `#26A69A`（緑） |
| 陰線 | ローソク足 | 終値 < 始値の場合<br>色: `#EF5350`（赤） |
| ツールチップ | ホバー表示 | ローソク足にマウスオーバーで表示<br>・日付<br>・始値<br>・終値<br>・安値<br>・高値 |

#### 2.2.3 ニュースマーカー

| 項目名 | 種別 | 説明 |
|--------|------|------|
| ニュースマーカー | 散布図 | その日の高値位置にマーカーを表示<br>サイズ: 12px<br>外枠: 白色ボーダー（2px） |
| センチメント表示 | 色分け | ・ポジティブ: `#4CAF50`（緑）<br>・ネガティブ: `#F44336`（赤）<br>・中立: `#9E9E9E`（グレー） |
| 通常時ラベル | 吹き出し | ニュースタイトルの短縮版（15文字まで）<br>センチメント色の背景、白文字<br>フォントサイズ: 11px、太字<br>パディング: 6px 10px<br>角丸: 6px<br>影: 軽い影効果 |
| ホバー時ラベル | 拡張吹き出し | 以下の詳細情報を表示:<br>・ニュースタイトル（全文）<br>・日付と時刻（📅アイコン付き）<br>・要約（存在する場合）<br>・センチメント（🏷アイコン付き）<br>・ニュースソース（📰アイコン付き、存在する場合）<br>幅: 280px、自動折り返し<br>パディング: 12px 16px<br>行の高さ: 18px<br>影: 強い影効果 |

#### 2.2.4 ズーム・パン機能

| 項目名 | 種別 | 説明 |
|--------|------|------|
| ホイールズーム | 操作 | マウスホイールでチャート範囲を拡大・縮小<br>カーソル位置を中心にズーム |
| スライダーズーム | スライダー | チャート下部のスライダーで表示範囲を調整<br>位置: bottom 5%<br>高さ: 30px<br>初期表示範囲: 0-100%（全データ表示） |
| パン操作 | ドラッグ | チャート上でドラッグして表示範囲を移動 |

### 2.3 状態表示

| 項目名 | 種別 | 説明 |
|--------|------|------|
| ローディング表示 | スピナー/テキスト | データ取得中は「読み込み中...」を表示 |
| エラー表示 | エラーメッセージ | エラー内容と再試行ボタンを表示 |
| データ無し表示 | メッセージ | 「この銘柄の株価データがありません。」を表示 |

---

## 3. 操作処理詳細

### 3.1 画面初期表示処理

#### 処理概要
URLパラメータから銘柄コードを取得し、該当銘柄の株価データとニュースデータをバックエンドから取得して、チャートを初期描画する。

#### 処理フロー
1. URLパラメータから`stockCode`を取得
2. 銘柄コードが存在しない場合、エラーメッセージ「銘柄コードが指定されていません」を表示して終了
3. 銘柄コードが存在する場合、ローディング状態を表示
4. `GET /api/v1/stocks/:stockCode/prices` APIを呼び出して株価データを取得
5. データ取得成功時:
   - 株価データをローソク足形式に変換
   - ニュースデータが存在する場合、散布図用のデータに変換
   - チャートを描画
6. データ取得失敗時:
   - エラー種別を判定
   - 適切なエラーメッセージを表示
   - リトライ可能なエラーの場合、再試行ボタンを表示

#### データ取得API
- **エンドポイント**: `GET /api/v1/stocks/:stockCode/prices`
- **パスパラメータ**:
  - `stockCode`: 4桁の銘柄コード（大文字に自動変換）
- **クエリパラメータ（オプション）**:
  - `startDate`: 開始日（YYYY-MM-DD形式）
  - `endDate`: 終了日（YYYY-MM-DD形式）
  - `limit`: 取得件数制限
- **成功レスポンス（200 OK）**:
```typescript
{
  success: true,
  data: {
    stockCode: string,
    prices: [
      {
        priceId: string,
        stockId: number,
        tradeDate: Date,
        openPrice: Decimal,
        highPrice: Decimal,
        lowPrice: Decimal,
        closePrice: Decimal,
        volume: string,
        createdAt: Date,
        updatedAt: Date
      }
    ],
    total: number
  }
}
```

### 3.2 チャート描画処理

#### 処理概要
取得した株価データとニュースデータをECharts形式に変換し、インタラクティブなローソク足チャートとニュースマーカーを描画する。

#### 処理フロー
1. EChartsインスタンスを初期化
2. 株価データを変換:
   - 日付配列: すべての取引日を抽出
   - 値配列: 各日の `[始値, 終値, 安値, 高値]` の配列に変換
3. ニュースデータが存在する場合:
   - 各ニュースの表示位置を計算（該当日の高値位置）
   - センチメントに応じた色を設定
   - 通常時ラベル（短縮タイトル）とホバー時ラベル（詳細情報）を設定
4. チャートオプションを生成:
   - タイトル設定
   - 軸設定（X軸: 日付、Y軸: 価格）
   - ツールチップ設定（ローソク足のみ表示）
   - 凡例設定（株価、ニュース）
   - ズーム設定（ホイールズーム、スライダーズーム）
   - シリーズ設定（ローソク足、ニュース散布図）
5. チャートを描画
6. ウィンドウリサイズイベントを監視

#### データ変換ロジック

**株価データ変換**:
```typescript
const dates = stockData.map(d => d.date);
const values = stockData.map(d => [d.open, d.close, d.low, d.high]);
```

**ニュースデータ変換**:
```typescript
{
  value: [news.date, priceMap[news.date]],  // [日付, その日の高値]
  newsData: news,  // カスタムデータ
  itemStyle: {
    color: sentimentConfig[news.sentiment].color,
    borderColor: '#fff',
    borderWidth: 2
  },
  label: {
    show: true,
    formatter: () => news.title.substring(0, 15) + '...',
    backgroundColor: sentimentConfig[news.sentiment].color,
    // ...その他スタイル設定
  }
}
```

### 3.3 リサイズ処理

#### 処理概要
ブラウザウィンドウのサイズ変更に追従してチャートを再描画する。

#### 処理フロー
1. コンポーネントマウント時に`window.resize`イベントリスナーを登録
2. ウィンドウリサイズが発生したら、EChartsの`resize()`メソッドを呼び出す
3. チャートが新しいコンテナサイズに合わせて再描画される
4. コンポーネントアンマウント時にイベントリスナーを削除
5. EChartsインスタンスを破棄してメモリを解放

### 3.4 ツールチップ表示処理（ローソク足）

#### 処理概要
ユーザーがローソク足にマウスカーソルを合わせたとき、その日の株価詳細情報をポップアップ表示する。

#### 処理フロー
1. ユーザーがローソク足にマウスオーバー
2. カーソル位置のデータポイントを特定
3. シリーズ名が「株価」の場合のみツールチップを表示
4. 以下の情報を整形して表示:
   - 📊 日付（例: `1/15`）
   - 始値
   - 終値
   - 安値
   - 高値
5. HTMLフォーマットでスタイル付きツールチップを表示
6. マウスアウトでツールチップを非表示

#### 表示条件
- `seriesName === '株価'` の場合のみ表示
- `seriesName === 'ニュース'` の場合は空文字を返す（ニュースは吹き出しで表示）

### 3.5 ニュース吹き出し表示処理

#### 処理概要（通常時）
ニュースマーカー上に、センチメントを色で示した短縮タイトルのラベルを常時表示する。

#### 処理フロー（通常時）
1. 各ニュースマーカーの上部にラベルを表示
2. タイトルが15文字を超える場合、15文字で切り詰めて末尾に`...`を追加
3. センチメントに応じた背景色で表示:
   - ポジティブ: `#4CAF50`（緑）
   - ネガティブ: `#F44336`（赤）
   - 中立: `#9E9E9E`（グレー）
4. 白文字、太字、角丸、影付きスタイルで表示

#### 処理概要（ホバー時）
ユーザーがニュースマーカーにマウスカーソルを合わせたとき、吹き出しを拡張してニュースの詳細情報を表示する。

#### 処理フロー（ホバー時）
1. ユーザーがニュースマーカーにマウスオーバー
2. 吹き出しを拡張（幅280px）
3. 以下の詳細情報を複数行で表示:
   ```
   [ニュースタイトル（全文）]

   📅 [日付] [時刻]

   [要約（存在する場合）]

   🏷 [センチメント] | 📰 [ニュースソース（存在する場合）]
   ```
4. テキストが長い場合は自動的に折り返し（`overflow: 'break'`）
5. マーカーのボーダーを太く（3px）、影を強調
6. マウスアウトで通常のラベル表示に戻る

### 3.6 ズーム操作処理

#### 3.6.1 マウスホイールズーム

##### 処理概要
チャート上でマウスホイールを操作して、表示範囲を拡大・縮小する。

##### 処理フロー
1. ユーザーがチャート上でマウスホイールを操作
2. ホイールの回転方向を検知:
   - 上に回転: ズームイン（拡大）
   - 下に回転: ズームアウト（縮小）
3. マウスカーソル位置を中心に表示範囲を調整
4. チャートを再描画
5. スライダーの位置も連動して更新

##### 設定
```typescript
dataZoom: [
  {
    type: 'inside',  // ホイールズーム有効化
    start: 0,
    end: 100
  }
]
```

#### 3.6.2 スライダーズーム

##### 処理概要
チャート下部のスライダーをドラッグして、表示する日付範囲を選択する。

##### 処理フロー
1. ユーザーがスライダーのハンドルをドラッグ
2. ハンドルの位置から表示開始位置と終了位置を計算（パーセンテージ）
3. 計算した範囲のデータのみを表示
4. チャートを再描画
5. 初期状態では全データ（0-100%）を表示

##### 設定
```typescript
dataZoom: [
  {
    show: true,
    type: 'slider',
    bottom: '5%',
    start: 0,
    end: 100,
    height: 30
  }
]
```

### 3.7 凡例切り替え処理

#### 処理概要
ユーザーが凡例の項目をクリックして、株価またはニュースの表示・非表示を切り替える。

#### 処理フロー
1. ユーザーが凡例の「株価」または「ニュース」をクリック
2. クリックされた項目の表示状態を反転（表示 ⇔ 非表示）
3. 該当するシリーズをチャート上で表示/非表示
4. 凡例の項目スタイルを更新:
   - 表示中: 通常色
   - 非表示: グレーアウト
5. 初期状態では両方とも表示

#### 設定
```typescript
legend: {
  data: ['株価', 'ニュース'],
  bottom: 10,
  selected: {
    '株価': true,
    'ニュース': true
  }
}
```

### 3.8 戻るボタン処理

#### 処理概要
株一覧画面へ戻る。

#### 処理フロー
1. ユーザーが「← 株一覧に戻る」ボタンをクリック
2. React Routerの`navigate`関数を使用して`/stocks`へ遷移
3. 株一覧画面が表示される

### 3.9 再試行ボタン処理

#### 処理概要
エラー発生時にデータ取得を再実行する。

#### 処理フロー
1. エラー発生後、ユーザーが「再試行」ボタンをクリック
2. エラー表示をクリア
3. ローディング状態を表示
4. 初期表示処理（3.1）を再実行
5. 成功時: チャートを描画
6. 失敗時: エラーメッセージを再表示

#### 表示条件
- API取得エラー発生時のみボタンを表示
- 銘柄コード未指定エラー時は非表示（再試行しても解決しないため）

---

## 4. エラーハンドリング

### 4.1 エラー種別

| エラー種別 | HTTPステータス | 表示メッセージ | 対応 |
|-----------|--------------|---------------|------|
| 銘柄コード未指定 | - | 「銘柄コードが指定されていません」 | エラー表示のみ（再試行不可） |
| バリデーションエラー | 400 Bad Request | 「入力内容に誤りがあります」 | エラー表示 + 株一覧へ戻るボタン |
| 銘柄コードが見つからない | 404 Not Found | 「指定された銘柄コードが見つかりません」 | エラー表示 + 株一覧へ戻るボタン |
| 株価データが見つからない | 404 Not Found | 「この銘柄の株価データがありません。」 | メッセージ表示 + 株一覧へ戻るボタン |
| サーバーエラー | 500 Internal Server Error | 「サーバーエラーが発生しました」 | エラー表示 + 再試行ボタン |
| ネットワークエラー | - | 「株価データの取得に失敗しました」 | エラー表示 + 再試行ボタン |

### 4.2 エラー処理フロー

1. データ取得中にエラーが発生
2. エラーオブジェクトからエラー情報を取得
3. HTTPステータスコードまたは`error.code`を確認
4. エラー種別に応じた処理を実行:
   - **銘柄コード未指定**: 「銘柄コードが指定されていません」を表示、再試行ボタンなし
   - **VALIDATION_ERROR (400)**: 「入力内容に誤りがあります」を表示、株一覧へ戻るボタンを表示
   - **STOCK_CODE_NOT_FOUND (404)**: 「指定された銘柄コードが見つかりません」を表示、株一覧へ戻るボタンを表示
   - **STOCK_PRICE_NOT_FOUND (404)**: 「この銘柄の株価データがありません。」を表示、株一覧へ戻るボタンを表示
   - **INTERNAL_SERVER_ERROR (500)**: 「サーバーエラーが発生しました」を表示、再試行ボタンを表示
   - **ネットワークエラー**: 「株価データの取得に失敗しました」を表示、再試行ボタンを表示
5. ローディング状態を解除
6. コンソールに詳細なエラーログを出力（開発者向け）

### 4.3 エラーレスポンス例

#### 銘柄コードが見つからない（404）
```typescript
{
  success: false,
  error: {
    code: "STOCK_CODE_NOT_FOUND",
    message: "指定された銘柄コードが見つかりません",
    details: {
      stockCode: "9999"
    }
  }
}
```

#### 株価データが見つからない（404）
```typescript
{
  success: false,
  error: {
    code: "STOCK_PRICE_NOT_FOUND",
    message: "指定された銘柄の株価データが見つかりません",
    details: {
      stockCode: "7203"
    }
  }
}
```

#### サーバーエラー（500）
```typescript
{
  success: false,
  error: {
    code: "INTERNAL_SERVER_ERROR",
    message: "サーバーエラーが発生しました"
  }
}
```
